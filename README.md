# test_05


Чтобы запустить проект, который ты описал, следуй этим шагам:

Шаг 1: Установка зависимостей
Для начала тебе нужно установить все зависимости, указанные в файле requirements.txt. Чтобы это сделать:

Убедись, что у тебя установлен Python 3.10 или выше.

В корне проекта создай виртуальное окружение и активируй его:

Для Windows:

bash
Копировать
Редактировать
python -m venv venv
venv\Scripts\activate
Для Mac/Linux:

bash
Копировать
Редактировать
python3 -m venv venv
source venv/bin/activate
Установи зависимости:

bash
Копировать
Редактировать
pip install --no-cache-dir -r requirements.txt
Убедись, что у тебя есть файл requirements.txt, в котором указаны все необходимые пакеты (например, FastAPI, Opentelemetry, Prometheus, и т.д.).

Если его нет, можешь вручную установить пакеты:

bash
Копировать
Редактировать
pip install fastapi opentelemetry-api opentelemetry-sdk opentelemetry-exporter-jaeger prometheus_client psutil uvicorn
Шаг 2: Настройка переменных окружения
Ты используешь dotenv, чтобы загружать переменные окружения из .env файла. Убедись, что у тебя есть файл .env в корне проекта с необходимыми переменными:

Пример .env:

env
Копировать
Редактировать
TEST_EMAIL=test@example.com
TEST_CODE=123456
SENDER_EMAIL=your-email@gmail.com
SENDER_PASSWORD=your-email-password
Шаг 3: Запуск сервера FastAPI
В директории проекта запусти сервер FastAPI с помощью uvicorn:

bash
Копировать
Редактировать
uvicorn main:app --reload
main — это имя Python файла, который ты запускаешь (в данном случае, main.py).
app — это экземпляр приложения FastAPI в файле main.py.
Параметр --reload используется для автоматической перезагрузки сервера при изменении кода.
Если у тебя приложение использует другой файл, например, app.py, то укажи его вместо main.

После запуска ты должен увидеть что-то вроде этого:

bash
Копировать
Редактировать
INFO:     Uvicorn running on http://127.0.0.1:8001 (Press CTRL+C to quit)
Теперь твое приложение доступно по адресу http://127.0.0.1:8001.

Шаг 4: Запуск Prometheus
Ты настроил Prometheus для экспонирования метрик на порту 8000. Чтобы Prometheus собрал эти метрики, нужно:

Запустить сервер Prometheus на порту 8000:

bash
Копировать
Редактировать
start_http_server(8000)
Теперь метрики будут доступны по адресу http://localhost:8000/metrics.

Если у тебя установлен Prometheus, можешь настроить его для сбора метрик с этого порта.

Шаг 5: Настройка Jaeger (если нужно)
Ты настроил экспорт трассировок в Jaeger. Чтобы видеть трассировки:

Убедись, что Jaeger работает. Ты можешь запустить Jaeger в Docker-контейнере для тестов:

bash
Копировать
Редактировать
docker run --rm -it --name jaeger \
  -e COLLECTOR_ZIPKIN_HTTP_HTTP_PORT=9411 \
  -p5775:5775 -p6831:6831/udp -p6832:6832/udp \
  -p5778:5778 -p16686:16686 -p14250:14250 -p14268:14268 \
  -p14250:14250 -p14268:14268 \
  jaegertracing/all-in-one:latest
Ты сможешь зайти в Jaeger UI по адресу http://localhost:16686 и просматривать трассировки.

Шаг 6: Запуск тестов с Behave
Ты настроил поведение тестов с использованием библиотеки behave. Чтобы запустить тесты:

Убедись, что все шаги в тестах корректно написаны.

Запусти тесты командой:

bash
Копировать
Редактировать
behave
Это запустит тесты в соответствии с функциональными требованиями, которые ты описал в файле с фичами (.feature).

Шаг 7: Проверка
После запуска ты можешь проверить, что сервер работает по адресу http://localhost:8001.
Проверяй метрики через http://localhost:8000/metrics.
Проверяй трассировки через Jaeger UI на http://localhost:16686.
Резюме
Установи зависимости с pip install.
Настрой .env файл.
Запусти сервер FastAPI с uvicorn main:app --reload.
Запусти сервер Prometheus для сбора метрик.
Запусти Jaeger, если нужно для трассировок.
Запусти тесты с behave









Лабораторная работа направлена на интеграцию средств трассировки и мониторинга в проект с использованием OpenTelemetry для сбора информации о производительности, а также логирования. Давайте разберем ключевые аспекты вашего кода и используемые библиотеки:

1. Используемые библиотеки:
FastAPI: используется для создания API.
OpenTelemetry:
Для трассировки использованы opentelemetry и его компоненты:
TracerProvider: предоставляет API для создания трассировок.
BatchSpanProcessor и ConsoleSpanExporter: экспортируют трассировки, как в консоль, так и в Jaeger.
JaegerExporter: экспортирует трассировки в систему Jaeger.
LoggingInstrumentor: интегрирует трассировки с логированием.
FastAPIInstrumentor: инструмент для интеграции с FastAPI.
Prometheus:
prometheus_client: используется для экспонирования метрик.
PrometheusMetricReader: компонент OpenTelemetry для сбора метрик.
Psutil: библиотека для мониторинга системных ресурсов (CPU, память).
Behave: фреймворк для тестирования поведения (BDD).
requests используется для взаимодействия с API в тестах.
2. Основная логика:
В коде реализованы следующие функциональности:

Мониторинг и трассировка с OpenTelemetry:

Для сбора метрик используются PrometheusMetricReader и MeterProvider.
Трассировки отправляются в Jaeger с помощью JaegerExporter.
FastAPIInstrumentor подключает трассировку к FastAPI, автоматически создавая трассировки для каждого запроса.
LoggingInstrumentor позволяет связать логи с трассировками.
Мониторинг ресурсов:

Используется psutil для измерения CPU и памяти. Созданы два наблюдаемых индикатора:
cpu_usage: процент использования процессора.
memory_usage: объем памяти, используемой процессом.
Эти метрики собираются через MeterProvider и отправляются в Prometheus, чтобы их можно было экспортировать для дальнейшего анализа.
Трассировка и логирование:

Весь процесс обработки запросов (например, регистрация, вход, сброс пароля) логируется с помощью стандартного Python логера, который интегрирован с OpenTelemetry.
Используются трассировки (span), чтобы отслеживать длительность операций и других метрик.
3. Метрики и отчеты:
Метрики (CPU, память) экспортируются в Prometheus, который используется для мониторинга производительности приложения.
В отчете можно будет сравнить ресурсы, затраченные на работу приложения и на трассировку/мониторинг/логирование.
Пример конфигурации Prometheus для сбора метрик:
yaml
Копировать
Редактировать
scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
Эта конфигурация заставляет Prometheus собирать метрики с сервера, на котором он работает.
4. Тесты с использованием Behave:
Тесты описывают сценарии, такие как регистрация пользователя, вход, сброс пароля и удаление аккаунта.
Для каждого сценария выполняются HTTP запросы к API, после чего проверяется успешность выполнения (например, правильный код подтверждения или успешная авторизация).
Например, сценарий для регистрации пользователя:
python
Копировать
Редактировать
@when('the user registers')
def step_register(context):
   response = requests.post(f"{BASE_URL}/register", json={
       "email": context.email,
       "password": context.password
   })
   context.response = response
5. Docker Compose:
Используется Docker Compose для настройки сервисов:
App: ваш основной сервер, на котором работает FastAPI.
Jaeger: система для трассировки.
Prometheus: для сбора метрик.
Behave Tests: контейнер, где запускаются тесты с использованием Behave.
6. Конфигурация OpenTelemetry и Prometheus:
Для OpenTelemetry создаются провайдеры трассировок и метрик.
Трассировки экспортируются в Jaeger, а метрики (например, использование CPU и памяти) экспортируются в Prometheus, который потом может быть использован для мониторинга.
Запуск сервера Prometheus:
python
Копировать
Редактировать
start_http_server(8000)
7. Сценарии трассировки:
В трассировках вы отслеживаете:

Время, затраченное на каждую операцию API.
Использование системных ресурсов (CPU, память).
Логирование вместе с трассировками для каждой операции.
Вывод:
Лабораторная работа интегрирует OpenTelemetry для трассировки и мониторинга системы, а также настраивает Prometheus для сбора метрик и Jaeger для визуализации трассировок. Используя библиотеки psutil, openTelemetry, Prometheus, и Behave, вы можете собрать подробные данные о производительности и отладке вашего приложения, а затем проанализировать их для оптимизации и улучшения стабильности.